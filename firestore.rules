rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============ HELPER FUNCTIONS ============

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isParticipant(matchId) {
      return request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.participantIds;
    }

    function isMatchCreator(matchId) {
      return get(/databases/$(database)/documents/matches/$(matchId)).data.createdBy == request.auth.uid;
    }

    function isValidScore(score) {
      return score >= 1 && score <= 20;
    }

    function isValidHandicap(handicap) {
      return handicap == null || (handicap >= 0 && handicap <= 54);
    }

    // ============ USERS ============

    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false; // Users cannot delete themselves
    }

    // ============ MATCHES ============

    match /matches/{matchId} {
      allow read: if isSignedIn() && isParticipant(matchId);
      allow create: if isSignedIn();
      allow update: if isParticipant(matchId);
      allow delete: if isMatchCreator(matchId);

      // -------- BETS --------
      match /bets/{betId} {
        allow read: if isParticipant(matchId);
        allow create: if isMatchCreator(matchId);
        allow update: if isMatchCreator(matchId);
        allow delete: if isMatchCreator(matchId)
          && get(/databases/$(database)/documents/matches/$(matchId)).data.status == 'pending';
      }

      // -------- PARTICIPANTS --------
      match /participants/{participantId} {
        allow read: if isParticipant(matchId);
        allow create: if isSignedIn(); // Anyone can join via invite
        allow update: if isOwner(participantId) || isMatchCreator(matchId);
        allow delete: if false; // Cannot remove participants
      }

      // -------- SCORES --------
      match /scores/{scoreId} {
        allow read: if isParticipant(matchId);
        allow create: if isParticipant(matchId)
          && isValidScore(request.resource.data.strokes);
        allow update: if isParticipant(matchId)
          && isValidScore(request.resource.data.strokes)
          && request.resource.data.version == resource.data.version + 1;
        allow delete: if false; // Scores are immutable
      }

      // -------- LEDGER --------
      match /ledger/{entryId} {
        allow read: if isSignedIn()
          && (resource.data.fromUserId == request.auth.uid
              || resource.data.toUserId == request.auth.uid);
        allow create: if false; // System-generated only
        allow update: if isSignedIn()
          && (resource.data.fromUserId == request.auth.uid
              || resource.data.toUserId == request.auth.uid)
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['settled', 'settledAt', 'settledBy']);
        allow delete: if false;
      }

      // -------- AUDIT --------
      match /audit/{auditId} {
        allow read: if isParticipant(matchId);
        allow write: if false; // Cloud Functions only
      }
    }

    // ============ INVITES ============

    match /invites/{inviteId} {
      allow read: if true; // Public for link validation
      allow create: if isSignedIn();
      allow update: if false; // Server-side consumption only
      allow delete: if false;
    }

    // ============ GROUPS ============

    function isGroupMember(groupId) {
      return request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.memberIds;
    }

    function isGroupCreator(groupId) {
      return get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid;
    }

    match /groups/{groupId} {
      // Members can read their groups
      allow read: if isSignedIn()
        && request.auth.uid in resource.data.memberIds;

      // Any authenticated user can create a group
      allow create: if isSignedIn()
        && request.auth.uid in request.resource.data.memberIds
        && request.resource.data.createdBy == request.auth.uid;

      // Only creator can update (name, settings, add/remove members)
      allow update: if isSignedIn()
        && resource.data.createdBy == request.auth.uid;

      // Only creator can delete
      allow delete: if isSignedIn()
        && resource.data.createdBy == request.auth.uid;
    }

    // ============ SEASONS ============

    match /seasons/{seasonId} {
      // Members of parent group can read
      allow read: if isSignedIn()
        && isGroupMember(resource.data.groupId);

      // System/Cloud Functions create seasons
      // Allow create if user is group member (for auto-creation)
      allow create: if isSignedIn()
        && isGroupMember(request.resource.data.groupId);

      // Only update standings (Cloud Functions preferred, but allow group members)
      allow update: if isSignedIn()
        && isGroupMember(resource.data.groupId)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['standings', 'status']);

      // No deletes
      allow delete: if false;
    }

    // ============ BET TEMPLATES ============

    match /betTemplates/{templateId} {
      // Owner can read their templates
      allow read: if isSignedIn()
        && resource.data.userId == request.auth.uid;

      // Owner can create templates
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid;

      // Owner can update their templates
      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid;

      // Owner can delete their templates
      allow delete: if isSignedIn()
        && resource.data.userId == request.auth.uid;
    }
  }
}
